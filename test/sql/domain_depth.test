# name: test/sql/domain_depth.test
# description: test netquack domain_depth function
# group: [sql]

require netquack

# ===========================================================================
# Basic domain depth
# ===========================================================================

query I
SELECT domain_depth('example.com');
----
2

query I
SELECT domain_depth('sub.example.com');
----
3

query I
SELECT domain_depth('a.b.example.com');
----
4

query I
SELECT domain_depth('a.b.c.d.example.com');
----
6

# ===========================================================================
# Full URLs — host is extracted first
# ===========================================================================

query I
SELECT domain_depth('http://example.com/path');
----
2

query I
SELECT domain_depth('https://www.example.com/page?q=1');
----
3

query I
SELECT domain_depth('https://sub.domain.example.com:8080/path#frag');
----
4

query I
SELECT domain_depth('http://a.b.c.d.example.co.uk/page');
----
7

query I
SELECT domain_depth('ftp://files.archive.example.org/pub');
----
4

# ===========================================================================
# Protocol-relative URLs
# ===========================================================================

query I
SELECT domain_depth('//www.example.com/path');
----
3

query I
SELECT domain_depth('//example.com');
----
2

# ===========================================================================
# With port numbers
# ===========================================================================

query I
SELECT domain_depth('http://example.com:8080');
----
2

query I
SELECT domain_depth('https://api.example.com:443/v1');
----
3

# ===========================================================================
# With userinfo
# ===========================================================================

query I
SELECT domain_depth('http://user:pass@example.com/path');
----
2

query I
SELECT domain_depth('http://user@sub.example.com/path');
----
3

# ===========================================================================
# Case insensitivity
# ===========================================================================

query I
SELECT domain_depth('HTTP://EXAMPLE.COM/PATH');
----
2

query I
SELECT domain_depth('https://WWW.EXAMPLE.COM');
----
3

query I
SELECT domain_depth('Sub.Example.COM');
----
3

# ===========================================================================
# Country-code and multi-part TLDs
# ===========================================================================

query I
SELECT domain_depth('example.co.uk');
----
3

query I
SELECT domain_depth('http://www.example.co.uk');
----
4

query I
SELECT domain_depth('http://shop.example.com.au/products');
----
4

query I
SELECT domain_depth('http://example.org.br');
----
3

# ===========================================================================
# Single-label domains (no dots)
# ===========================================================================

query I
SELECT domain_depth('localhost');
----
1

query I
SELECT domain_depth('intranet');
----
1

# ===========================================================================
# Trailing dot (DNS canonical form)
# ===========================================================================

query I
SELECT domain_depth('example.com.');
----
2

# Trailing dot in full URL — host parser cannot extract, returns 0
query I
SELECT domain_depth('http://www.example.com./path');
----
0

# ===========================================================================
# IPv4 addresses — return 0 (not a domain)
# ===========================================================================

query I
SELECT domain_depth('192.168.1.1');
----
0

query I
SELECT domain_depth('http://192.168.1.1:8080/path');
----
0

query I
SELECT domain_depth('http://10.0.0.1');
----
0

# ===========================================================================
# IPv6 addresses — return 0 (not a domain)
# ===========================================================================

query I
SELECT domain_depth('http://[::1]:8080/path');
----
0

query I
SELECT domain_depth('http://[2001:db8::1]/page');
----
0

# ===========================================================================
# Edge cases
# ===========================================================================

# Empty string
query I
SELECT domain_depth('');
----
0

# NULL
query I
SELECT domain_depth(NULL);
----
NULL

# Just a scheme
query I
SELECT domain_depth('http://');
----
0

# Very deep domain
query I
SELECT domain_depth('a.b.c.d.e.f.g.h.i.j.example.com');
----
12

# Domain with hyphens
query I
SELECT domain_depth('my-site.example.com');
----
3

query I
SELECT domain_depth('http://my-awesome-site.co.uk');
----
3

# ===========================================================================
# Table usage
# ===========================================================================

statement ok
CREATE OR REPLACE TABLE depth_test AS
    SELECT 'http://example.com' AS url UNION ALL
    SELECT 'https://www.example.com' UNION ALL
    SELECT 'http://a.b.c.example.com' UNION ALL
    SELECT 'http://192.168.1.1' UNION ALL
    SELECT NULL;

query II
SELECT url, domain_depth(url) AS depth FROM depth_test ORDER BY depth, url;
----
http://192.168.1.1	0
http://example.com	2
https://www.example.com	3
http://a.b.c.example.com	5
NULL	NULL

# Group by depth
query II
SELECT domain_depth(url) AS depth, count(*) AS cnt FROM depth_test WHERE url IS NOT NULL GROUP BY depth ORDER BY depth;
----
0	1
2	1
3	1
5	1

statement ok
DROP TABLE depth_test;
